<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detecting Spreadsheet Smells with xlex() • tidyxl</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Detecting Spreadsheet Smells with xlex()">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-45097885-4"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-45097885-4');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidyxl</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.0.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tidyxl.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data-validation-rules.html">Data Validation Rules</a>
    </li>
    <li>
      <a href="../articles/smells.html">Detecting Spreadsheet Smells with xlex()</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nacnudus/tidyxl">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Detecting Spreadsheet Smells with xlex()</h1>
                        <h4 class="author">Duncan Garmonsway</h4>
            
            <h4 class="date">2019-01-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nacnudus/tidyxl/blob/master/vignettes/smells.Rmd"><code>vignettes/smells.Rmd</code></a></small>
      <div class="hidden name"><code>smells.Rmd</code></div>

    </div>

    
    
<p>The function <code><a href="../reference/xlex.html">xlex()</a></code> separates formulas into tokens of different types, and gives their depth within a nested formula. Its name is a bad pun on ‘Excel’ and ‘lexer’. Try the <a href="https://duncan-garmonsway.shinyapps.io/xlex/">online demo</a> or install the more experimental <a href="https://nacnudus.github.io/lexl">lexl</a> package to run <code>demo_lexl()</code> locally.</p>
<p>It is useful for detecting spreadsheet smells, which are poor practices in spreadsheet design, such as deep nests of functions, or embedding constants in formulas.</p>
<div id="inspecting-the-parse-tree" class="section level2">
<h2 class="hasAnchor">
<a href="#inspecting-the-parse-tree" class="anchor"></a>Inspecting the parse tree</h2>
<p>Here’s an example with a simple formula <code>MIN(3,MAX(2,A1))</code> (the <code>=</code> symbol at the beginning of the formula is implied, because Excel doesn’t write it to the file).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(tidyxl)</a>
<a class="sourceLine" id="cb1-2" title="2">x &lt;-<span class="st"> </span><span class="kw"><a href="../reference/xlex.html">xlex</a></span>(<span class="st">"MIN(3,MAX(2,A1))"</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">x</a></code></pre></div>
<pre><code>## root            
## ¦-- MIN         function
## °-- (           fun_open
##     ¦-- 3       number
##     ¦-- ,       separator
##     ¦-- MAX     function
##     °-- (       fun_open
##         ¦-- 2   number
##         ¦-- ,   separator
##         °-- A1  ref
##     °-- )       fun_close
## °-- )           fun_close</code></pre>
</div>
<div id="detecting-constants-inside-formulas" class="section level2">
<h2 class="hasAnchor">
<a href="#detecting-constants-inside-formulas" class="anchor"></a>Detecting constants inside formulas</h2>
<p>A smelly spreadsheet is distributed with the <code>tidyxl</code> package. It comes from the famous Enron subpoena, made available by <a href="http://www.felienne.com/archives/3634">Felienne Hermans</a>.</p>
<p>How does it look at a glance? Here’s a screenshot of part of one sheet, showing the formulas rather than the cell values. It’s a financial plan, using formulas to forecast the rest of the year, and the plan for the following year.</p>
<p>What we want to see is whether the formulas have any embedded constants; ones that are hidden from our attention, but that are driving the forecasts. While we could read each formula, one by one, it would be a lot easier to visualise the ones containing constants. We can do this with <code><a href="../reference/xlex.html">xlex()</a></code> and a graph plotting library like <code>ggplot2</code>.</p>
<p>The first step, after importing the spreadsheet, is to tokenize the formulas, using <code>xlsx()</code>. Let’s tokenize one formula to see what it looks like.</p>
<div id="one-formula" class="section level3">
<h3 class="hasAnchor">
<a href="#one-formula" class="anchor"></a>One formula</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(dplyr)</a></code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">library</span>(tidyr)</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="kw">library</span>(purrr)</a>
<a class="sourceLine" id="cb7-3" title="3"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb7-4" title="4"></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co"># The original filename was "barry_tycholiz__848__2002 Plan Worksheet CC107322.xlsx"</span></a>
<a class="sourceLine" id="cb7-6" title="6">sheet &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tidy_xlsx.html">tidy_xlsx</a></span>(<span class="kw">system.file</span>(<span class="st">"extdata/enron-constants.xlsx"</span>,</a>
<a class="sourceLine" id="cb7-7" title="7">                               <span class="dt">package =</span> <span class="st">"tidyxl"</span>),</a>
<a class="sourceLine" id="cb7-8" title="8">                   <span class="st">"Detail Breakdown"</span>)<span class="op">$</span>data[[<span class="dv">1</span>]]</a></code></pre></div>
<pre><code>## Warning: 'tidy_xlsx()' is deprecated.
## Use 'xlsx_cells()' or 'xlsx_formats()' instead.</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">sheet<span class="op">$</span>formula[<span class="dv">22</span>]</a></code></pre></div>
<pre><code>## [1] "(C8/7)*12-48000"</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="kw"><a href="../reference/xlex.html">xlex</a></span>(sheet<span class="op">$</span>formula[<span class="dv">22</span>])</a></code></pre></div>
<pre><code>## root        
## °-- (       paren_open
##     ¦-- C8  ref
##     ¦-- /   operator
##     °-- 7   number
## ¦-- )       paren_close
## ¦-- *       operator
## ¦-- 12      number
## ¦-- -       operator
## °-- 48000   number</code></pre>
<p>The formula is <code>(C8/7)*12-48000</code>, and <code><a href="../reference/xlex.html">xlex()</a></code> separates it into its components. There are the parentheses, the operators (division, multiplication, subtraction), a reference to another cell (<code>C8</code>), and a few numeric constants: 7, 12, and 48000. What could they be?</p>
<p>The 7 is probably the 7th month, July, because of the column header “July YTD”. A year-to-date figure is being divided by 7, then multiplied by 12 to forecast the year-end figure. The 48000 is more mysterious – perhaps a future payment is expected.</p>
<p>Embedding these constants inside a formula is bad practice. Better practice would be to put the constants into their own cells, where they could be annotated with their meaning, and perhaps even named. Then formulas could refer to them, by name, e.g.</p>
<pre><code>(Compensation/MonthsToDate)*12Months-FuturePayments</code></pre>
</div>
<div id="many-formulas" class="section level3">
<h3 class="hasAnchor">
<a href="#many-formulas" class="anchor"></a>Many formulas</h3>
<p>The <code><a href="../reference/xlex.html">xlex()</a></code> function isn’t vectorized (because it returns a data frame), so we map it over each of the formulas to create a ‘nest’ column of individual data frames.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">tokens &lt;-</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="st">  </span>sheet <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span><span class="kw">is.na</span>(formula)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(row, col, formula) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tokens =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(formula, xlex)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>formula)</a>
<a class="sourceLine" id="cb14-7" title="7">tokens</a></code></pre></div>
<pre><code>## # A tibble: 154 x 3
##      row   col tokens          
##    &lt;int&gt; &lt;int&gt; &lt;list&gt;          
##  1     8     4 &lt;tibble [9 × 3]&gt;
##  2     9     4 &lt;tibble [7 × 3]&gt;
##  3    10     4 &lt;tibble [7 × 3]&gt;
##  4    12     4 &lt;tibble [7 × 3]&gt;
##  5    13     4 &lt;tibble [7 × 3]&gt;
##  6    14     3 &lt;tibble [4 × 3]&gt;
##  7    14     4 &lt;tibble [4 × 3]&gt;
##  8    14     5 &lt;tibble [4 × 3]&gt;
##  9    14     6 &lt;tibble [4 × 3]&gt;
## 10    17     4 &lt;tibble [7 × 3]&gt;
## # … with 144 more rows</code></pre>
<p>Then we can unnest the data frames and filter for tokens that are constants, to find out which cells have constants in their formulas.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">constants &lt;-</a>
<a class="sourceLine" id="cb16-2" title="2"><span class="st">  </span>tokens <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(tokens) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(type <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"error"</span>, <span class="st">"bool"</span>, <span class="st">"number"</span>, <span class="st">"text"</span>))</a>
<a class="sourceLine" id="cb16-5" title="5">constants</a></code></pre></div>
<pre><code>## # A tibble: 201 x 5
##      row   col level type   token
##    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;
##  1     8     4     1 number 7    
##  2     8     4     0 number 12   
##  3     8     4     0 number 48000
##  4     9     4     1 number 7    
##  5     9     4     0 number 12   
##  6    10     4     1 number 7    
##  7    10     4     0 number 12   
##  8    12     4     1 number 7    
##  9    12     4     0 number 12   
## 10    13     4     1 number 7    
## # … with 191 more rows</code></pre>
<p>Which constants are most common? Unsurprisingly, 12 and 7 are almost equally abundant, but there are also lots of 6s and 9s – two- and three-quarterly figures? Then there are some 150000s and the familiar 48000s, followed by some fractions that look like percentages, and then several one-offs.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">constants <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/tally.html">count</a></span>(token, <span class="dt">sort =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="st">  </span><span class="kw">print</span>(<span class="dt">n =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<pre><code>## # A tibble: 24 x 2
##    token      n
##    &lt;chr&gt;  &lt;int&gt;
##  1 12        59
##  2 7         58
##  3 6         30
##  4 9         30
##  5 150000     4
##  6 48000      2
##  7 0.05       1
##  8 0.1        1
##  9 0.35       1
## 10 0.5        1
## 11 1.05       1
## 12 10         1
## 13 10000      1
## 14 12000      1
## 15 13000      1
## 16 15000      1
## 17 2000       1
## 18 25000      1
## 19 5000       1
## 20 5320       1
## 21 7314       1
## 22 7800       1
## 23 866        1
## 24 95000      1</code></pre>
</div>
<div id="visualising-constants" class="section level3">
<h3 class="hasAnchor">
<a href="#visualising-constants" class="anchor"></a>Visualising constants</h3>
<p>A final step is to visualize the spreadsheet, highlighting cells that hide constants in their formulas. We already have a data frame of cells with constants, so we join it back to the full dataset, and pass the result into <code>ggplot</code>.</p>
<p>This time there doesn’t seem to be any particular pattern, which is perhaps suspicious in itself.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">has_constants &lt;-</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">  </span>constants <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(row, col) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">has_constant =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(sheet, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"row"</span>, <span class="st">"col"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(row, col, has_constant) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span>(<span class="kw">list</span>(<span class="dt">has_constant =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb20-9" title="9">has_constants</a></code></pre></div>
<pre><code>## # A tibble: 412 x 3
##      row   col has_constant
##    &lt;int&gt; &lt;int&gt; &lt;lgl&gt;       
##  1     1     1 FALSE       
##  2     2     1 FALSE       
##  3     3     3 FALSE       
##  4     3     4 FALSE       
##  5     3     5 FALSE       
##  6     3     6 FALSE       
##  7     4     3 FALSE       
##  8     4     4 FALSE       
##  9     4     5 FALSE       
## 10     4     6 FALSE       
## # … with 402 more rows</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1">has_constants <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">  </span><span class="co"># filter(row &lt;= 28) %&gt;%</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(col, row, <span class="dt">fill =</span> has_constant)) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_reverse</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a></code></pre></div>
<p><img src="smells_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
</div>
<div id="detecting-deeply-nested-formulas" class="section level2">
<h2 class="hasAnchor">
<a href="#detecting-deeply-nested-formulas" class="anchor"></a>Detecting deeply nested formulas</h2>
<p>Using the same techniques as for detecting constants, we map <code><a href="../reference/xlex.html">xlex()</a></code> over the formulas in a spreadsheet, unnest the result, and filter for tokens with particular properties. In this case, we are interested in the <code>level</code> of each token, which tells how deeply a token is nested in other functions and expressions.</p>
<p>This time, we use another spreadsheet from the Enron corpus. First, an illustration. Notice that inside the first function, the level increases to 1. Inside the second function, the level increases to 2.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="kw"><a href="../reference/xlex.html">xlex</a></span>(<span class="st">"MAX(3,MIN(2,4))"</span>)</a></code></pre></div>
<pre><code>## root           
## ¦-- MAX        function
## °-- (          fun_open
##     ¦-- 3      number
##     ¦-- ,      separator
##     ¦-- MIN    function
##     °-- (      fun_open
##         ¦-- 2  number
##         ¦-- ,  separator
##         °-- 4  number
##     °-- )      fun_close
## °-- )          fun_close</code></pre>
<p>Now let’s apply the same test to all the formulas in a sheet. The deepest level of nesting turns out to be 7, and is seen in all the cells in row 171.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="co"># The original filename was "albert_meyers__1__1-25act.xlsx"</span></a>
<a class="sourceLine" id="cb25-2" title="2">sheet &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tidy_xlsx.html">tidy_xlsx</a></span>(<span class="kw">system.file</span>(<span class="st">"extdata/enron-nested.xlsx"</span>,</a>
<a class="sourceLine" id="cb25-3" title="3">                               <span class="dt">package =</span> <span class="st">"tidyxl"</span>),</a>
<a class="sourceLine" id="cb25-4" title="4">                   <span class="st">"Preschedule"</span>)<span class="op">$</span>data[[<span class="dv">1</span>]]</a></code></pre></div>
<pre><code>## Warning: 'tidy_xlsx()' is deprecated.
## Use 'xlsx_cells()' or 'xlsx_formats()' instead.</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">deepest &lt;-</a>
<a class="sourceLine" id="cb27-2" title="2"><span class="st">  </span>sheet <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-3" title="3"><span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="op">!</span><span class="kw">is.na</span>(formula)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-4" title="4"><span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">tokens =</span> <span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(formula, xlex)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-5" title="5"><span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(row, col, tokens) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-6" title="6"><span class="st">    </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(tokens) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-7" title="7"><span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(level <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(level)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-8" title="8"><span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>(row, col, level)</a>
<a class="sourceLine" id="cb27-9" title="9">deepest</a></code></pre></div>
<pre><code>## # A tibble: 48 x 3
##      row   col level
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1   171     2     7
##  2   171     3     7
##  3   171     4     7
##  4   171     5     7
##  5   171     6     7
##  6   171     7     7
##  7   171     8     7
##  8   171     9     7
##  9   171    10     7
## 10   171    11     7
## # … with 38 more rows</code></pre>
<p>Do you wonder what those formulas look like?</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">sheet <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(row <span class="op">==</span><span class="st"> </span><span class="dv">171</span>, col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/pull.html">pull</a></span>(formula) <span class="co"># Aaaaaaaaaaarghhhhhhhh!</span></a></code></pre></div>
<pre><code>## [1] "((IF((103-B$89)=103,0,(103-B$89)))+(IF((200-B$95)=200,0,(200-B$95)))+(IF((196-B$98)=196,0,(196-B$98)))+(IF((200-B$101)=200,0,(200-B$101)))+(IF((70-B$104)=70,0,(MIN(40,(70-B$104))))+(IF((78-B$109)=78,0,(MIN(50,(78-B$109)))))+(IF((103-B$114)=103,0,(MIN(66,(103-B$114)))))+(IF((195-B$119-B$124-B$129-B$134-B$139)=195,0,(MIN(70,(195-B$119-B$124-B$129-B$134-B$139)))))+(IF((64-B$144)=64,0,(MIN(50,(64-B$144)))))+(IF((48-B$149)=48,0,(MIN(20,(48-B$149)))))+(IF((44-B$154)=44,0,(MIN(20,(44-B$154)))))+(IF((130-B$159)=130,0,(MIN(20,(130-B$159)))))))"</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#inspecting-the-parse-tree">Inspecting the parse tree</a></li>
      <li><a href="#detecting-constants-inside-formulas">Detecting constants inside formulas</a></li>
      <li><a href="#detecting-deeply-nested-formulas">Detecting deeply nested formulas</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Duncan Garmonsway.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
